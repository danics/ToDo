@model IEnumerable<ToDoProjeto.ViewModels.Tarefas.TarefaViewModel>

@{
	ViewData["Title"] = "Tarefas";
	Layout = "~/Views/Shared/_Layout.cshtml";
	var ListaTitulo = ViewData["ListaTitulo"] as ListaDeTarefa;	
}
<head>
	<meta charset="utf-8" />    
    <title>@ViewData["Title"] - Tarefas</title>
</head>
<body>	
		<h1>@ListaTitulo.Nome</h1>
		@DateTime.Now.ToString("dddd, dd MMMM")
		<br>
		<br>
		<div asp-controller="Tarefas" asp-action="Edit">
			<input class="novaTarefa" href="#" placeholder=" + Adicionar uma tarefa" maxlength="255"><br>	
			<div class="itens">																							
				@foreach (var item in Model)
				{					
					<div class="row pb-3 pt-3 border-bottom">
						<svg height="24" width="24" viewBox="0 0 24 24">
  							<circle class="circulo" cx="10" cy="10" r="8" stroke="gray" stroke-width="1" fill="white" data="@item.Id"></circle>
						</svg>
						<div class="tarefa ml-3" id="tarefa" data="@item.Id">@item.Descricao</div>	
					</div>					
				}
			</div>	
		</div>			

<style>
input{       
        border: 0px;
    	outline: 0px;       
}
circle.preenchimento{
	fill: gray;
}
div.tarefa.decoration{
	text-decoration: line-through;
}
div.tarefaDinamico.decoration{
	text-decoration: line-through;
}
</style>

@section scripts{
	<script type="text/javascript">
		$(document).ready(function () {			
			let id;	
			let atributo;
			let data;			

			$(".novaTarefa").keypress(function(e) {        
        		if(e.which == 13) {                
            		let descricaoTarefa = $(this).val();
					$.ajax({
                    		method: "POST",
                    		url:'@Url.Action("Create", "Tarefas")',
                    		data: {Descricao: descricaoTarefa, Status: 0, ListaDeTarefaId: @ListaTitulo.Id }
					}).done(function (resposta) {
                        CriaTarefa(resposta);
                    }); 
					function CriaTarefa(tarefa){
						//var hash = new Date().getTime().toString();						
						var descricao = tarefa.descricao;	
						id = tarefa.id;					
						$(".itens").append('<div class="row pb-3 pt-3 border-bottom"><svg height="24" width="24" viewBox="0 0 24 24"><circle class="circuloDinamico" cx="10" cy="10" r="8" stroke="gray" stroke-width="1" fill="white" data-hash="#"></circle></svg><div class="tarefaDinamico ml-3" id="tarefa" data-hash="#">' + descricao + '</div></div>');						
						//$(".circuloDinamico").attr("data-hash", hash);
						//$(".tarefaDinamico").attr("data-hash", hash);						
						$(".novaTarefa").val("");
					}					
				}
			});

			$(document).on('click', '.circulo', function () {	
				var item = $(this).attr("data");			
				$(".circulo[data=" + item + "]").toggleClass("preenchimento");				
				$(".tarefa[data=" + item + "]").toggleClass("decoration");
			});

			$(document).on('click', '.circuloDinamico', function () {
				var hash = new Date().getTime().toString();
				$(this).attr("data-hash", hash)		
				var item = $(this).attr("data-hash");	
				$(this).parent().parent().find(".tarefaDinamico").attr("data-hash", item)						
				$(".circuloDinamico[data-hash=" + item + "]").toggleClass("preenchimento");				
				$(".tarefaDinamico[data-hash=" + item + "]").toggleClass("decoration");
			});	


			$(document).on('contextmenu', "div[id=tarefa]", function(e) {
        		var top = e.pageY - 10;
        		var left = e.pageX - 10;
				atributo = $(this).attr("class");
				data = $(this).attr("data");									
        
    			$("#context-menu").css({
        			display: "block",
        			top: top,
        			left: left
    			}).addClass("show");
    				return false; 
    		})

    		$(".container").on("click", function() {
    			$("#context-menu").removeClass("show").hide();
    		});

    		$("#context-menu a").on("click", function() {
    			$(this).parent().removeClass("show").hide();
    		});	


			$(document).on('click', '.excluirTarefa', function(){
				if(atributo === "tarefaDinamico ml-3"){
					$.ajax({
                    		method: "POST",
                    		url:'@Url.Action("Delete", "Tarefas")',
                    		data: {Id: id },
							success: function() {   
								location.reload();  
							}
					});
				}
				else if(atributo === "tarefa ml-3")
				{
					$.ajax({
                    		method: "POST",
                    		url:'@Url.Action("Delete", "Tarefas")',
                    		data: {Id: data },
							success: function() {   
								location.reload();  
							}							
					});
				}
				
			});			

		});
	</script>
}
</body>
